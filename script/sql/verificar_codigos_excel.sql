-- ============================================================================
-- SCRIPT DE VERIFICACIÓN: Códigos de Excel en tbl_partes
-- ============================================================================
--
-- Este script verifica qué códigos del archivo MEDICIONES OTS.xlsx
-- existen en la tabla tbl_partes y cuáles faltan.
--
-- Total de códigos en Excel: 821
--
-- Uso en MySQL Workbench:
--   1. Abrir este archivo
--   2. Ejecutar todo el script (Ctrl+Shift+Enter)
--   3. Revisar los resultados en la pestaña de salida
-- ============================================================================

USE cert_dev;

-- Crear tabla temporal con los códigos del Excel
DROP TEMPORARY TABLE IF EXISTS tmp_codigos_excel;

CREATE TEMPORARY TABLE tmp_codigos_excel (
    codigo VARCHAR(50) PRIMARY KEY,
    origen VARCHAR(20) DEFAULT 'EXCEL'
);

-- Insertar los 821 códigos únicos encontrados en MEDICIONES OTS.xlsx
-- Formato normalizado: convertido de OT/0121 a OT-0121

INSERT INTO tmp_codigos_excel (codigo) VALUES
('GF-0001'),
('GF-0002'),
('GF-0003'),
('GF-0004'),
('GF-0005'),
('GF-0006'),
('OT-0092'),
('OT-0093'),
('OT-0094'),
('OT-0095'),
('OT-0096'),
('OT-0097'),
('OT-0098'),
('OT-0099'),
('OT-0100'),
('OT-0101'),
('OT-0102'),
('OT-0103'),
('OT-0104'),
('OT-0105'),
('OT-0106'),
('OT-0107'),
('OT-0108'),
('OT-0109'),
('OT-0110'),
('OT-0111'),
('OT-0112'),
('OT-0113'),
('OT-0114'),
('OT-0115'),
('OT-0116'),
('OT-0117'),
('OT-0118'),
('OT-0119'),
('OT-0120'),
('OT-0121'),
('OT-0122'),
('OT-0123'),
('OT-0124'),
('OT-0125'),
('OT-0126'),
('OT-0127'),
('OT-0128'),
('OT-0129'),
('OT-0130'),
('OT-0131'),
('OT-0132'),
('OT-0133'),
('OT-0134'),
('OT-0135'),
('OT-0136'),
('OT-0137'),
('OT-0138'),
('OT-0139'),
('OT-0140'),
('OT-0141'),
('OT-0142'),
('OT-0143'),
('OT-0144'),
('OT-0145'),
('OT-0146'),
('OT-0147'),
('OT-0148'),
('OT-0149'),
('OT-0150'),
('OT-0151'),
('OT-0152'),
('OT-0153'),
('OT-0154'),
('OT-0155'),
('OT-0156'),
('OT-0157'),
('OT-0158'),
('OT-0159'),
('OT-0160'),
('OT-0161'),
('OT-0162'),
('OT-0163'),
('OT-0164'),
('OT-0165'),
('OT-0166'),
('OT-0167'),
('OT-0168'),
('OT-0169'),
('OT-0170'),
('OT-0171'),
('OT-0172'),
('OT-0173'),
('OT-0174'),
('OT-0175'),
('OT-0176'),
('OT-0177'),
('OT-0178'),
('OT-0179'),
('OT-0180'),
('OT-0181'),
('OT-0182'),
('OT-0183'),
('OT-0184'),
('OT-0185'),
('OT-0186'),
('OT-0187'),
('OT-0188'),
('OT-0189'),
('OT-0190'),
('OT-0191'),
('OT-0192'),
('OT-0193'),
('OT-0194'),
('OT-0195'),
('OT-0196'),
('OT-0197'),
('OT-0198'),
('OT-0199'),
('OT-0200'),
('OT-0201'),
('OT-0202'),
('OT-0203'),
('OT-0204'),
('OT-0205'),
('OT-0206'),
('OT-0207'),
('OT-0208'),
('OT-0209'),
('OT-0210'),
('OT-0211'),
('OT-0212'),
('OT-0213'),
('OT-0214'),
('OT-0215'),
('OT-0216'),
('OT-0217'),
('OT-0218'),
('OT-0219'),
('OT-0220'),
('OT-0221'),
('OT-0222'),
('OT-0223'),
('OT-0224'),
('OT-0225'),
('OT-0226'),
('OT-0227'),
('OT-0228'),
('OT-0229'),
('OT-0230'),
('OT-0231'),
('OT-0232'),
('OT-0233'),
('OT-0234'),
('OT-0235'),
('OT-0236'),
('OT-0237'),
('OT-0238'),
('OT-0239'),
('OT-0240'),
('OT-0241'),
('OT-0242'),
('OT-0243'),
('OT-0244'),
('OT-0245'),
('OT-0246'),
('OT-0247'),
('OT-0248'),
('OT-0249'),
('OT-0250'),
('OT-0251'),
('OT-0252'),
('OT-0253'),
('OT-0254'),
('OT-0255'),
('OT-0256'),
('OT-0257'),
('OT-0258'),
('OT-0259'),
('OT-0260'),
('OT-0261'),
('OT-0262'),
('OT-0263'),
('OT-0264'),
('OT-0265'),
('OT-0266'),
('OT-0267'),
('OT-0268'),
('OT-0269'),
('OT-0270'),
('OT-0271'),
('OT-0272'),
('OT-0273'),
('OT-0274'),
('OT-0275'),
('OT-0276'),
('OT-0277'),
('OT-0278'),
('OT-0279'),
('OT-0280'),
('OT-0281'),
('OT-0282'),
('OT-0283'),
('OT-0284'),
('OT-0285'),
('OT-0286'),
('OT-0287'),
('OT-0288'),
('OT-0289'),
('OT-0290'),
('OT-0291'),
('OT-0292'),
('OT-0293'),
('OT-0294'),
('OT-0295'),
('OT-0296'),
('OT-0297'),
('OT-0298'),
('OT-0299'),
('OT-0300'),
('OT-0301'),
('OT-0302'),
('OT-0303'),
('OT-0304'),
('OT-0305'),
('OT-0306'),
('OT-0307'),
('OT-0308'),
('OT-0309'),
('OT-0310'),
('OT-0311'),
('OT-0312'),
('OT-0313'),
('OT-0314'),
('OT-0315'),
('OT-0316'),
('OT-0317'),
('OT-0318'),
('OT-0319'),
('OT-0320'),
('OT-0321'),
('OT-0322'),
('OT-0323'),
('OT-0324'),
('OT-0325'),
('OT-0326'),
('OT-0327'),
('OT-0328'),
('OT-0329'),
('OT-0330'),
('OT-0331'),
('OT-0332'),
('OT-0333'),
('OT-0334'),
('OT-0335'),
('OT-0336'),
('OT-0337'),
('OT-0338'),
('OT-0339'),
('OT-0340'),
('OT-0341'),
('OT-0342'),
('OT-0343'),
('OT-0344'),
('OT-0345'),
('OT-0346'),
('OT-0347'),
('OT-0348'),
('OT-0349'),
('OT-0350'),
('OT-0351'),
('OT-0352'),
('OT-0353'),
('OT-0354'),
('OT-0355'),
('OT-0356'),
('OT-0357'),
('OT-0358'),
('OT-0359'),
('OT-0360'),
('OT-0361'),
('OT-0362'),
('OT-0364'),
('OT-0365'),
('OT-0366'),
('OT-0367'),
('OT-0368'),
('OT-0369'),
('OT-0370'),
('OT-0371'),
('OT-0372'),
('OT-0373'),
('OT-0374'),
('OT-0375'),
('OT-0376'),
('OT-0377'),
('OT-0378'),
('OT-0379'),
('OT-0380'),
('OT-0381'),
('OT-0382'),
('OT-0383'),
('OT-0384'),
('OT-0385'),
('OT-0386'),
('OT-0387'),
('OT-0388'),
('OT-0389'),
('OT-0390'),
('OT-0391'),
('OT-0392'),
('OT-0393'),
('OT-0394'),
('OT-0395'),
('OT-0396'),
('OT-0397'),
('OT-0398'),
('OT-0399'),
('OT-0400'),
('OT-0401'),
('OT-0402'),
('OT-0403'),
('OT-0404'),
('OT-0405'),
('OT-0406'),
('OT-0407'),
('OT-0408'),
('OT-0409'),
('OT-0410'),
('OT-0411'),
('OT-0412'),
('OT-0413'),
('OT-0414'),
('OT-0415'),
('OT-0416'),
('OT-0417'),
('OT-0418'),
('OT-0419'),
('OT-0420'),
('OT-0421'),
('OT-0422'),
('OT-0423'),
('OT-0424'),
('OT-0425'),
('OT-0426'),
('OT-0427'),
('OT-0428'),
('OT-0429'),
('OT-0430'),
('OT-0431'),
('OT-0432'),
('OT-0433'),
('OT-0434'),
('OT-0435'),
('OT-0436'),
('OT-0437'),
('OT-0438'),
('OT-0439'),
('OT-0440'),
('OT-0441'),
('OT-0442'),
('OT-0443'),
('OT-0444'),
('OT-0445'),
('OT-0446'),
('OT-0447'),
('OT-0448'),
('OT-0449'),
('OT-0450'),
('OT-0451'),
('OT-0452'),
('OT-0453'),
('OT-0454'),
('OT-0455'),
('OT-0456'),
('OT-0458'),
('OT-0459'),
('OT-0460'),
('OT-0461'),
('OT-0462'),
('OT-0463'),
('OT-0464'),
('OT-0465'),
('OT-0466'),
('OT-0467'),
('OT-0468'),
('OT-0469'),
('OT-0470'),
('OT-0471'),
('OT-0472'),
('OT-0473'),
('OT-0474'),
('OT-0475'),
('OT-0476'),
('OT-0477'),
('OT-0478'),
('OT-0479'),
('OT-0480'),
('OT-0481'),
('OT-0482'),
('OT-0483'),
('OT-0484'),
('OT-0485'),
('OT-0486'),
('OT-0487'),
('OT-0488'),
('OT-0489'),
('OT-0490'),
('OT-0491'),
('OT-0492'),
('OT-0493'),
('OT-0494'),
('OT-0495'),
('OT-0496'),
('OT-0497'),
('OT-0498'),
('OT-0499'),
('OT-0500'),
('OT-0502'),
('OT-0503'),
('OT-0504'),
('OT-0505'),
('OT-0506'),
('OT-0507'),
('OT-0508'),
('OT-0509'),
('OT-0510'),
('OT-0511'),
('OT-0512'),
('OT-0513'),
('OT-0514'),
('OT-0515'),
('OT-0516'),
('OT-0517'),
('OT-0518'),
('OT-0519'),
('OT-0520'),
('OT-0521'),
('OT-0522'),
('TP-0001'),
('TP-0002'),
('TP-0003'),
('TP-0004'),
('TP-0005'),
('TP-0006'),
('TP-0007'),
('TP-0008'),
('TP-0009'),
('TP-0010'),
('TP-0011'),
('TP-0012'),
('TP-0013'),
('TP-0014'),
('TP-0015'),
('TP-0016'),
('TP-0017'),
('TP-0018'),
('TP-0019'),
('TP-0020'),
('TP-0021'),
('TP-0022'),
('TP-0023'),
('TP-0024'),
('TP-0025'),
('TP-0026'),
('TP-0027'),
('TP-0028'),
('TP-0029'),
('TP-0030'),
('TP-0031'),
('TP-0032'),
('TP-0033'),
('TP-0034'),
('TP-0035'),
('TP-0036'),
('TP-0037'),
('TP-0038'),
('TP-0039'),
('TP-0040'),
('TP-0041'),
('TP-0042'),
('TP-0043'),
('TP-0044'),
('TP-0045'),
('TP-0046'),
('TP-0048'),
('TP-0049'),
('TP-0050'),
('TP-0051'),
('TP-0052'),
('TP-0053'),
('TP-0054'),
('TP-0055'),
('TP-0056'),
('TP-0057'),
('TP-0058'),
('TP-0059'),
('TP-0060'),
('TP-0061'),
('TP-0062'),
('TP-0063'),
('TP-0064'),
('TP-0065'),
('TP-0066'),
('TP-0067'),
('TP-0068'),
('TP-0069'),
('TP-0070'),
('TP-0071'),
('TP-0072'),
('TP-0073'),
('TP-0074'),
('TP-0075'),
('TP-0076'),
('TP-0077'),
('TP-0078'),
('TP-0079'),
('TP-0080'),
('TP-0081'),
('TP-0082'),
('TP-0083'),
('TP-0084'),
('TP-0085'),
('TP-0086'),
('TP-0087'),
('TP-0088'),
('TP-0089'),
('TP-0090'),
('TP-0091'),
('TP-0092'),
('TP-0093'),
('TP-0094'),
('TP-0095'),
('TP-0096'),
('TP-0097'),
('TP-0098'),
('TP-0099'),
('TP-0100'),
('TP-0101'),
('TP-0102'),
('TP-0103'),
('TP-0104'),
('TP-0105'),
('TP-0106'),
('TP-0107'),
('TP-0109'),
('TP-0110'),
('TP-0111'),
('TP-0112'),
('TP-0113'),
('TP-0114'),
('TP-0115'),
('TP-0116'),
('TP-0117'),
('TP-0118'),
('TP-0119'),
('TP-0120'),
('TP-0121'),
('TP-0122'),
('TP-0123'),
('TP-0124'),
('TP-0125'),
('TP-0126'),
('TP-0127'),
('TP-0128'),
('TP-0129'),
('TP-0130'),
('TP-0131'),
('TP-0132'),
('TP-0133'),
('TP-0134'),
('TP-0135'),
('TP-0136'),
('TP-0137'),
('TP-0138'),
('TP-0139'),
('TP-0140'),
('TP-0141'),
('TP-0142'),
('TP-0143'),
('TP-0144'),
('TP-0145'),
('TP-0146'),
('TP-0147'),
('TP-0148'),
('TP-0149'),
('TP-0150'),
('TP-0151'),
('TP-0152'),
('TP-0153'),
('TP-0154'),
('TP-0155'),
('TP-0156'),
('TP-0157'),
('TP-0158'),
('TP-0159'),
('TP-0160'),
('TP-0161'),
('TP-0162'),
('TP-0163'),
('TP-0164'),
('TP-0165'),
('TP-0166'),
('TP-0167'),
('TP-0168'),
('TP-0169'),
('TP-0170'),
('TP-0171'),
('TP-0172'),
('TP-0173'),
('TP-0174'),
('TP-0175'),
('TP-0176'),
('TP-0177'),
('TP-0178'),
('TP-0179'),
('TP-0180'),
('TP-0181'),
('TP-0182'),
('TP-0183'),
('TP-0184'),
('TP-0185'),
('TP-0186'),
('TP-0187'),
('TP-0188'),
('TP-0189'),
('TP-0190'),
('TP-0191'),
('TP-0192'),
('TP-0193'),
('TP-0194'),
('TP-0195'),
('TP-0196'),
('TP-0197'),
('TP-0198'),
('TP-0199'),
('TP-0200'),
('TP-0201'),
('TP-0202'),
('TP-0203'),
('TP-0204'),
('TP-0205'),
('TP-0206'),
('TP-0207'),
('TP-0208'),
('TP-0209'),
('TP-0210'),
('TP-0211'),
('TP-0212'),
('TP-0213'),
('TP-0214'),
('TP-0215'),
('TP-0216'),
('TP-0217'),
('TP-0218'),
('TP-0219'),
('TP-0220'),
('TP-0221'),
('TP-0222'),
('TP-0223'),
('TP-0224'),
('TP-0225'),
('TP-0226'),
('TP-0227'),
('TP-0228'),
('TP-0229'),
('TP-0230'),
('TP-0231'),
('TP-0232'),
('TP-0233'),
('TP-0234'),
('TP-0235'),
('TP-0236'),
('TP-0237'),
('TP-0238'),
('TP-0239'),
('TP-0240'),
('TP-0241'),
('TP-0242'),
('TP-0243'),
('TP-0244'),
('TP-0245'),
('TP-0246'),
('TP-0247'),
('TP-0248'),
('TP-0249'),
('TP-0250'),
('TP-0251'),
('TP-0252'),
('TP-0253'),
('TP-0254'),
('TP-0255'),
('TP-0256'),
('TP-0257'),
('TP-0258'),
('TP-0259'),
('TP-0260'),
('TP-0261'),
('TP-0262'),
('TP-0263'),
('TP-0264'),
('TP-0265'),
('TP-0266'),
('TP-0267'),
('TP-0268'),
('TP-0269'),
('TP-0270'),
('TP-0271'),
('TP-0272'),
('TP-0273'),
('TP-0274'),
('TP-0275'),
('TP-0276'),
('TP-0277'),
('TP-0278'),
('TP-0279'),
('TP-0280'),
('TP-0281'),
('TP-0282'),
('TP-0283'),
('TP-0284'),
('TP-0285'),
('TP-0286'),
('TP-0287'),
('TP-0288'),
('TP-0289'),
('TP-0290'),
('TP-0291'),
('TP-0292'),
('TP-0294'),
('TP-0295'),
('TP-0296'),
('TP-0297'),
('TP-0298'),
('TP-0299'),
('TP-0300'),
('TP-0301'),
('TP-0302'),
('TP-0303'),
('TP-0304'),
('TP-0305'),
('TP-0306'),
('TP-0307'),
('TP-0308'),
('TP-0309'),
('TP-0310'),
('TP-0311'),
('TP-0312'),
('TP-0313'),
('TP-0314'),
('TP-0315'),
('TP-0316'),
('TP-0317'),
('TP-0318'),
('TP-0319'),
('TP-0320'),
('TP-0321'),
('TP-0322'),
('TP-0323'),
('TP-0324'),
('TP-0325'),
('TP-0326'),
('TP-0327'),
('TP-0328'),
('TP-0329'),
('TP-0330'),
('TP-0331'),
('TP-0332'),
('TP-0333'),
('TP-0334'),
('TP-0335'),
('TP-0336'),
('TP-0337'),
('TP-0338'),
('TP-0339'),
('TP-0340'),
('TP-0341'),
('TP-0342'),
('TP-0343'),
('TP-0344'),
('TP-0345'),
('TP-0346'),
('TP-0347'),
('TP-0348'),
('TP-0349'),
('TP-0350'),
('TP-0351'),
('TP-0352'),
('TP-0353'),
('TP-0354'),
('TP-0355'),
('TP-0356'),
('TP-0357'),
('TP-0358'),
('TP-0359'),
('TP-0360'),
('TP-0361'),
('TP-0362'),
('TP-0363'),
('TP-0364'),
('TP-0365'),
('TP-0366'),
('TP-0368'),
('TP-0369'),
('TP-0370'),
('TP-0371'),
('TP-0372'),
('TP-0373'),
('TP-0374'),
('TP-0375'),
('TP-0376'),
('TP-0377'),
('TP-0378'),
('TP-0379'),
('TP-0380'),
('TP-0381'),
('TP-0382'),
('TP-0383'),
('TP-0384'),
('TP-0385'),
('TP-0386'),
('TP-0387'),
('TP-0388'),
('TP-0389'),
('TP-0390'),
('TP-0391');


-- ============================================================================
-- ANÁLISIS 1: Resumen General
-- ============================================================================

SELECT
    'RESUMEN GENERAL' as Analisis,
    COUNT(*) as Total_Codigos_Excel,
    (SELECT COUNT(*) FROM tbl_partes) as Total_Codigos_BD,
    SUM(CASE WHEN p.id IS NOT NULL THEN 1 ELSE 0 END) as Codigos_Encontrados,
    SUM(CASE WHEN p.id IS NULL THEN 1 ELSE 0 END) as Codigos_Faltantes,
    ROUND(SUM(CASE WHEN p.id IS NOT NULL THEN 1 ELSE 0 END) / COUNT(*) * 100, 1) as Porcentaje_Cobertura
FROM tmp_codigos_excel e
LEFT JOIN tbl_partes p ON e.codigo = p.codigo;


-- ============================================================================
-- ANÁLISIS 2: Códigos que SÍ están en tbl_partes (ENCONTRADOS)
-- ============================================================================

SELECT
    'CÓDIGOS ENCONTRADOS' as Estado,
    e.codigo as Codigo_Excel,
    p.id as Parte_ID,
    p.descripcion as Descripcion,
    tt.nombre as Tipo_Trabajo
FROM tmp_codigos_excel e
INNER JOIN tbl_partes p ON e.codigo = p.codigo
LEFT JOIN dim_tipo_trabajo tt ON p.tipo_trabajo_id = tt.id
ORDER BY e.codigo;


-- ============================================================================
-- ANÁLISIS 3: Códigos que NO están en tbl_partes (FALTANTES)
-- ============================================================================

SELECT
    'CÓDIGOS FALTANTES' as Estado,
    e.codigo as Codigo_Excel,
    SUBSTRING_INDEX(e.codigo, '-', 1) as Prefijo,
    'NO EXISTE EN BD' as Observacion
FROM tmp_codigos_excel e
LEFT JOIN tbl_partes p ON e.codigo = p.codigo
WHERE p.id IS NULL
ORDER BY e.codigo;


-- ============================================================================
-- ANÁLISIS 4: Resumen por tipo de código (prefijo)
-- ============================================================================

SELECT
    SUBSTRING_INDEX(e.codigo, '-', 1) as Prefijo,
    COUNT(*) as Total_Excel,
    SUM(CASE WHEN p.id IS NOT NULL THEN 1 ELSE 0 END) as Encontrados,
    SUM(CASE WHEN p.id IS NULL THEN 1 ELSE 0 END) as Faltantes,
    ROUND(SUM(CASE WHEN p.id IS NOT NULL THEN 1 ELSE 0 END) / COUNT(*) * 100, 1) as Porcentaje_OK
FROM tmp_codigos_excel e
LEFT JOIN tbl_partes p ON e.codigo = p.codigo
GROUP BY SUBSTRING_INDEX(e.codigo, '-', 1)
ORDER BY Prefijo;


-- ============================================================================
-- ANÁLISIS 5: Primeros y últimos códigos faltantes (vista rápida)
-- ============================================================================

-- Primeros 10 faltantes
SELECT
    'PRIMEROS 10 FALTANTES' as Lista,
    e.codigo
FROM tmp_codigos_excel e
LEFT JOIN tbl_partes p ON e.codigo = p.codigo
WHERE p.id IS NULL
ORDER BY e.codigo
LIMIT 10;

-- Últimos 10 faltantes
SELECT
    'ÚLTIMOS 10 FALTANTES' as Lista,
    e.codigo
FROM tmp_codigos_excel e
LEFT JOIN tbl_partes p ON e.codigo = p.codigo
WHERE p.id IS NULL
ORDER BY e.codigo DESC
LIMIT 10;


-- ============================================================================
-- LIMPIEZA
-- ============================================================================

-- La tabla temporal se eliminará automáticamente al cerrar la conexión
-- DROP TEMPORARY TABLE IF EXISTS tmp_codigos_excel;

-- ============================================================================
-- FIN DEL SCRIPT
-- ============================================================================
